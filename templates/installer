%{ if system == "linux" }
#!/bin/bash
set -exu
exec > ${tmp_path}/hab_installer.log 2>&1

function install_jq {
  path="${tmp_path}/bin"
  if [[ ! -d "$${path}" ]]; then
    sudo mkdir -p $path
  fi

  jq_path="${tmp_path}/bin/jq"
  if [[ ! -f "$${jq_path}" ]]; then
    if hash curl; then
      sudo curl -L -o $${jq_path} ${jq_linux_url} && sudo chmod 755 $${jq_path}
    else
      sudo wget -O $${jq_path} ${jq_linux_url} && sudo chmod 755 $${jq_path}
    fi
  fi
}

function install_hab {
  if [[ ! -d /hab ]]; then
    curl -L -o ${tmp_path}/url_installer.sh ${hab_install_url} && sudo bash ${tmp_path}/url_installer.sh -v ${hab_version}
  fi
}

function install_hab_pkg {
  sudo hab license accept
  sudo hab pkg install ${effortless_hab_pkg}
}

function run_hab_package {
  service_name=$(echo "${effortless_hab_pkg}" | awk -F'/' '{print $2}')
  service_dir=/hab/svc/$${service_name}/data/nodes
  pushd $(hab pkg path ${effortless_hab_pkg})
    sudo $(hab pkg path $(grep "chef/chef-client" TDEPS))/bin/chef-client -z -j ${tmp_path}/dna.json
    sudo rm -rf $${service_dir}
  popd
}

install_jq
install_hab
install_hab_pkg
run_hab_package
%{ endif }

%{ if system == "windows" }

Set-MpPreference -DisableRealtimeMonitoring $true
Add-Type -AssemblyName System.IO.Compression.FileSystem

function Unzip {
  param([string]$zipfile, [string]$outpath)
  [System.IO.Compression.ZipFile]::ExtractToDirectory($zipfile, $outpath)
}

function dl_and_install($name, $url, $ag) {
  $Installer = $name
  $Ptarget = "${tmp_path}\$Installer"
  $ProgressPreference = 'SilentlyContinue'
  [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
  Invoke-WebRequest $url -OutFile $Ptarget
  if ($Installer -like '*.zip') {
    Unzip "$Ptarget" "$ag"
  }
}

function install_jq {
  $tmp_bin = "${tmp_path}\bin"
  if(!(test-path $tmp_bin)) {
    New-Item -ItemType Directory -Force -Path $tmp_bin
  }

  $jq_path = "$${tmp_bin}\jq.exe"
  if(!(test-path $jq_path)) {
    $ProgressPreference = 'SilentlyContinue'
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    Invoke-WebRequest ${jq_windows_url} -OutFile $jq_path
  }
}

function install_hab {
  if(!(test-path "C:\habitat")) {
    $env:Path += ";${tmp_path}\bin"
    $ProgressPreference = 'SilentlyContinue'
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    $release_path="${hab_install_url}/packages/habitat/stable/hab-x86_64-windows"
    $release=(Invoke-WebRequest $release_path).content| jq.exe -r '.versions[] | select(. | contains(\"${hab_version}\"))' 
    $package_name="hab-$release-x86_64-windows"
    $download_path="${hab_install_url}/content/habitat/stable/windows/x86_64/$package_name.zip?bt_package=hab-x86_64-windows"
    dl_and_install "habitat.zip" "$download_path" "C:\habitat"
    mv C:\habitat\hab-*\* C:\habitat\
  }
}

function install_hab_pkg {
  $env:Path += ";C:\habitat\"
  hab license accept
  hab pkg install ${effortless_hab_pkg}
}

function run_hab_package {
  $env:Path += ";C:\habitat\"
  Push-Location $(hab pkg path ${effortless_hab_pkg})
    Invoke-Expression "$(hab pkg path (Select-String -Pattern 'chef-client' -Path .\TDEPS | Out-String).Trim().split(':')[2])\bin\chef-client.bat -j ${tmp_path}\dna.json -z *>&1 > ${tmp_path}/chef_client_run.log"
    $service_name = "${effortless_hab_pkg}".split("/")[1]
    Remove-Item -LiteralPath "C:\hab\svc\$service_name\data\nodes" -Force -Recurse
  Pop-Location
}
install_jq
install_hab
install_hab_pkg
run_hab_package
Set-MpPreference -DisableRealtimeMonitoring $false
%{ endif }
